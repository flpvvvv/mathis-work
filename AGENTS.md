# AGENTS.md — Mathis Gallery

## Project

Public gallery webapp for Mathis's artwork at **works.mathis.day**. Neo-brutalism visual style.

- **Stack**: Next.js 15 (App Router), TypeScript, Tailwind CSS 4, shadcn/ui, Supabase (Auth + Postgres + Storage), React Query, Vercel
- **Design spec**: `docs/plans/2026-02-20-mathis-gallery-design.md`
- **Package manager**: pnpm

## Architecture

- Public gallery at `/` with Grid and Timeline views, infinite scroll, full-text search, tag and date filters
- Work detail at `/works/[id]` with image carousel
- Admin CRUD behind `/admin/*` (protected via middleware + Supabase Magic Link auth)
- Client-side perspective correction for uploaded photos (Canvas API + `perspective-transform`)

## Image Pipeline

- All images re-encoded to JPEG 80% on the client before upload
- Stored in Supabase Storage bucket `artworks` at `{work_id}/{image_id}.jpg`
- **No separate thumbnail files exist in Supabase**; thumbnails are generated by Next.js `<Image>` component optimization (responsive `srcset`, WebP/AVIF negotiation)
- `next.config.ts` allows `*.supabase.co` for remote image patterns
- Work detail gallery images use `quality={70}` and constrained `sizes` to reduce payload
- Gallery grid cards use `priority` loading for the first 4 images (above-fold); remaining use `loading="lazy"`

## SEO & Metadata

- `metadataBase` set to `https://works.mathis.day` in root layout
- Root layout uses `title.template` (`%s | Mathis Gallery`) so pages only need to set the page-specific part
- `/works/[id]` uses `generateMetadata` for dynamic OG/Twitter tags, canonical URL, and `article:published_time`
- Dynamic OG image at `/opengraph-image` generated via `next/og` (edge runtime) for homepage social sharing
- `/login` page has `robots: { index: false, follow: false }` to exclude from search
- `robots.ts` disallows `/admin`, `/api/admin`, `/login`; points to `/sitemap.xml`
- `sitemap.ts` dynamically lists all works from Supabase (up to 500 per page)

## Security

- Security headers set in both `next.config.ts` (`headers()` function) and middleware responses:
  - `X-Frame-Options: DENY` — clickjacking protection
  - `X-Content-Type-Options: nosniff` — MIME sniffing prevention
  - `Referrer-Policy: strict-origin-when-cross-origin`
  - `Strict-Transport-Security: max-age=63072000; includeSubDomains; preload` (HSTS)
  - `Permissions-Policy: camera=(), microphone=(), geolocation=(), interest-cohort=()`
  - `X-DNS-Prefetch-Control: on`
- Middleware (`src/lib/supabase/middleware.ts`) applies headers to all responses via `applySecurityHeaders()`
- HTTPS enforced by Vercel in production (308 redirect)
- Supabase anon key is intentionally public (client-side); audit tools flag it as a "leaked secret" — this is a false positive

## Supabase Setup Requirements

- Storage bucket `artworks` must exist (public read, admin write via RLS)
- RLS policies must allow: public SELECT on `works`, `images`, `tags`, `work_tags`; admin INSERT/UPDATE/DELETE on all four tables
- `profiles` table auto-created via trigger on auth signup; `is_admin` set manually in Supabase Dashboard
- Full-text search index on `works.description` using `tsvector` column `description_tsv`

## Conventions

- Tailwind CSS 4 theme variables in `@theme` block within `globals.css`
- Custom animations must be registered in `@theme` (e.g., `--animate-fade-in-up`) so `motion-safe:` variants work; plain CSS classes are invisible to Tailwind's variant system
- JSX string attributes and JSX text content do NOT process JS unicode escapes (`\u2026`); use the actual character (`…`) instead
- Neo-brutalist styling: `border-2`, `shadow-[var(--shadow-brutal)]`, `rounded-none`, sharp edges
- `motion-safe:` / `motion-reduce:` for all animations (respect `prefers-reduced-motion`)
- `focus-visible:ring-*` on all interactive elements
- Error messages use explicit user-facing copy (see design spec §9)
- Sonner toasts for non-blocking errors; inline confirmation for destructive actions
- Date/number formatting via `Intl.DateTimeFormat` / `Intl.NumberFormat`
- Meta descriptions must be 120–160 characters; titles must be ≥30 characters
- Every public page should export `metadata` (static) or `generateMetadata` (dynamic)

## Known Issues / Gotchas

- If gallery shows nothing after upload, check that the `animate-fade-in-up` animation is registered in `@theme` (not just as a standalone CSS class)
- If images don't appear in Supabase Storage after upload, verify: (1) `artworks` bucket exists, (2) bucket RLS allows admin uploads, (3) user is authenticated as admin
- The `getPublicImageUrl` helper constructs URLs as `{SUPABASE_URL}/storage/v1/object/public/artworks/{storage_path}`
- Squirrel audit reports "meta tags in body" on pages with `generateMetadata` — this is a known Next.js streaming behavior where React 19 emits meta tags in the body and the browser hoists them to `<head>`. Not fixable from application code; browsers handle it correctly
- Squirrel audit reports "leaked secrets" in minified JS bundles — these are false positives from minified variable names matching secret patterns (e.g., `addRef`, `disabl`, `hasInt`). The Supabase anon key is also flagged but is intentionally public
- Local `squirrel audit` against `localhost` will flag HTTPS and sitemap domain mismatches — only audit production (`https://works.mathis.day`) for accurate security/crawlability scores
